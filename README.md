# IMU 기반 경량 재활운동 자세 추론 및 보조 시스템 개발

### 1. 프로젝트 소개
#### 1.1. 배경 및 필요성

재활 운동은 정확한 자세가 중요하다. 정확한 자세 유지를 위해, HPE를 통해 환자의 재활운동 자세를 보조하는 방법을 생각해 볼 수 있다. 하지만 컴퓨터 비전을 통해 HPE를 수행하게 되면, 센서 장비가 고가라는 점과 사진을 촬영하여 처리하는 과정에서 개인 프라이버시가 침해될 수 있는 문제점이 존재한다.

따라서 이 과제에서는 컴퓨터 비전과 비교하여 상대적으로 저가이고, 폐쇄적이어서 프라이버시를 걱정할 필요가 없는 임베디드 환경에서 재활 운동 자세를 추론하는 것을 목표로 연구를 수행하였다.


#### 1.2. 목표 및 주요 내용

- BLE를 통해 IMU 데이터를 게이트웨이로 전송하는 시스템 개발
- 전송받은 데이터들의 동기화를 맞추는 시스템을 개발
- 자세 추론을 위한 머신러닝 모델의 학습
- 재활 동작 별로 측정 모듈 개수를 최적화

### 2. 상세설계
#### 2.1. 시스템 구성도

**센서 착용 위치**
<br>
<img src="https://github.com/user-attachments/assets/c4178bac-d06d-4661-8756-090856fb8233" width="300px" title="Title" alt="Alt text"></img>


**전체 시스템 흐름도**
<br>
<img src="https://github.com/user-attachments/assets/ff32aa22-6280-4d65-881b-c011e9085499" width="600px" title="Title" alt="Alt text"></img>


#### 2.2. 사용 기술

- 게이트웨이
  - 사용언어 : Python
  - 라이브러리
    - bleak : BLE 연결 담당
    - numpy : 데이터 처리
    - sklearn, tensorflow : 자세 추론 담당
    - fastapi, uvicorn : 웹 API 제공

- 펌웨어
  - 사용언어 : C
  - 개발 프레임워크 : ESP-IDF

#### 2.3 사용 장비

- ESP32-S3 개발보드
- Jetson Orin Nano


### 3. 설치 및 사용 방법

#### 3.1 펌웨어
ESP32-S3 기반의 6축 IMU 센서가 있는 개발보드를 여러 개 준비해 진행한다. 다른 ESP32 제품군을 사용해도 되지만 BLE는 지원해야 한다.

센서는 I2C 통신으로 보드와 연결되어 있다. 개발에 사용한 IMU 센서는 ICM-42670-P로, 다른 제품을 사용하려고 하면 해당 제품의 데이터시트를 확인하여 main/imu.h에 정의된 레지스터 주소를 수정할 필요가 있다.

또한 개발 보드에 연결된 LED를 통해 보드의 상태를 확인할 수 있는데, 개발 환경이 바뀌면 main/main.c에 정의된 GPIO 핀 번호를 수정할 필요가 있다. (LED 없어도 정상동작 가능)

ESP-IDF를 이용하여 빌드를 진행한다. 프로젝트는 board_firmware 폴더에 있다. 이때 개발 보드마다 개별의 이름을 갖도록, main.c에서 DEVICE_NAME과 DEV_ID의 알파벳을 바꿔줄 필요가 있다. 통신 포트(COMx)와 디바이스 타깃(esp32s3)을 설정한 뒤 프로젝트를 빌드하고 보드에 플래시하면 펌웨어 준비는 끝난다.

만약 esp 관련 경로 문제가 발생한다면 dependencies.lock에서 ESP-IDF가 설치된 경로를 수정할 필요가 있다.


#### 3.2 게이트웨이
게이트웨이 장비에서 센서들을 연결하고 데이터를 수집한다. 기본적으로 게이트웨이 장비(PC, Jetson 등등)는 Bluetooth 4.0 이상을 지원해야 한다.

게이트웨이는 두 가지 방법으로 센서와 연결할 수 있다. 첫째로, gateway 디렉토리의 blemaster.py를 실행하는 방법이다. CLI의 형태이고, 장치 연결 확인, 데이터 수집, 자세 추론을 전부 수행할 수 있다. 사용하기 전 gateway/devices.txt에 사용할 장비의 MAC주소와 이름을 작성할 필요가 있다.

둘째로, 웹을 이용하는 방법이 있다. 아래와 같이 파이썬을 이용한 API 서버를 실행시킨 후 GUI/index.html 문서를 열면 된다.
```
cd GUI     
uvicorn main:app
```
여기서는 장치 연결 확인과 자세 추론을 수행할 수 있다. 마찬가지로 사용하기 전 GUI/devices.txt에 사용할 장비의 MAC주소와 이름을 작성할 필요가 있다.



### 4. 소개 및 시연 영상

[2024년 전기 졸업과제 45 패트와 매트랩](https://youtu.be/8_2EiJ4fJU8)

### 5. 팀 소개

- 하규승
  - hgs6417@gmail.com
  - 측정 모듈-게이트웨이간 BLE 통신 구현
  - 게이트웨이 - 유저간 feedback 구현
  - 데이터셋 제작
  - 모델 학습 및 평가
  - 서비스 구현
  - 최적화 및 디버깅

- 김지훈
  - hoon5916@naver.com
  - 센서값 수신 및 데이터 전처리
  - 수신값 동기화 구현
  - 데이터셋 제작
  - 모델 학습 및 평가
  - 서비스 구현
  - 최적화 및 디버깅
